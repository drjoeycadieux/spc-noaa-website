<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Alertes M√©t√©o et G√©omatique - SPC / NEXRAD / IGO</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css"
      rel="stylesheet"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* CSS de base */
      body {
        margin: 0;
        padding: 0;
        font-family: "Roboto", sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: #f0f2f5;
      }

      /* --- Style de l'En-t√™te (Header) --- */
      header {
        background-color: #1a237e;
        color: white;
        padding: 18px 30px;
        font-size: 1.6em;
        font-weight: 700;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 10;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* Conteneur des boutons de l'en-t√™te */
      .header-links a {
        color: white;
        text-decoration: none;
        margin-left: 20px;
        font-size: 0.85em;
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        transition: background-color 0.2s;
        font-weight: 400;
      }

      .header-links a:hover {
        background-color: #3f51b5;
      }

      /* Conteneur principal */
      #main-container {
        display: flex;
        flex: 1;
        position: relative;
      }

      /* --- Style de la Barre Lat√©rale (Sidebar) --- */
      #sidebar {
        width: 320px;
        background-color: white;
        padding: 25px;
        overflow-y: auto;
        box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 5;
        border-right: none;
      }

      /* Style de la L√©gende et des titres */
      #sidebar h3,
      #sidebar h4 {
        margin-top: 0;
        color: #1a237e;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 8px;
        margin-bottom: 20px;
        font-weight: 700;
      }

      /* Styles g√©n√©raux pour les listes */
      #sidebar ul {
        padding-left: 20px;
        margin: 10px 0 20px 0;
        font-size: 0.95em;
      }

      /* Style du bouton Player */
      #play-button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.05em;
        font-weight: 700;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s, transform 0.1s;
        width: 100%;
      }

      #play-button:hover {
        background-color: #388e3c;
      }

      #play-button:active {
        transform: scale(0.98);
      }

      /* --- Style de la Carte (Map) --- */
      #map {
        flex: 1;
        position: relative;
      }

      /* Styles de la l√©gende pour les alertes SPC */
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        font-size: 0.95em;
      }
      .legend-color {
        width: 25px;
        height: 25px;
        margin-right: 15px;
        border: 2px solid #000;
        opacity: 0.7;
        border-radius: 4px;
      }

      /* Style pour le s√©parateur horizontal */
      hr {
        border: 0;
        border-top: 1px solid #e0e0e0;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <header>
      <div>Alertes M√©t√©o et G√©omatique - SPC / NEXRAD / IGO</div>

      <div class="header-links">
        <a href="https://github.com/drjoeycadieux" target="_blank">
          <span role="img" aria-label="GitHub">üêô</span> GitHub
        </a>
        <a href="https://x.com/drjoeycadieux" target="_blank">
          <span role="img" aria-label="X">üê¶‚Äç‚¨õ</span> X
        </a>
      </div>
    </header>

    <div id="main-container">
      <aside id="sidebar">
        <h3>L√©gende des Alertes SPC</h3>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #ffff00"></div>
          <span>1 - Marginal Risk (Risque Marginal)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #ffa500"></div>
          <span>2 - Slight Risk (Risque L√©ger)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #ff4500"></div>
          <span>3 - Enhanced / Moderate Risk (Risque Mod√©r√©/Am√©lior√©)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #ff0000"></div>
          <span>4 - High Risk (Risque √âlev√©)</span>
        </div>

        <hr />

        <h4>Couches Actives</h4>
        <ul>
          <li>**IGO Fond de Carte** (Base Topo Qu√©bec)</li>
          <li>**IGO √âv√©nements Historiques** (GeoJSON)</li>
          <li>Radar NEXRAD (Couche Raster)</li>
          <li>Pr√©visions SPC NOAA (GeoJSON)</li>
        </ul>

        <hr />

        <h4>Contr√¥le des Donn√©es</h4>
        <button id="play-button">‚ñ∂Ô∏è D√©marrer l'Animation</button>
        <div
          id="time-display"
          style="
            margin-top: 15px;
            font-weight: 700;
            color: #1a237e;
            text-align: center;
          "
        >
          Heure : Statique
        </div>
      </aside>

      <div id="map"></div>
    </div>

    <script>
      // ----------------------------------------------------------------
      // Configuration de base
      // ----------------------------------------------------------------
      // ** IMPORTANT : REMPLACEZ CECI PAR VOTRE VRAI JETON D'ACC√àS MAPBOX **
      mapboxgl.accessToken =
        "pk.eyJ1Ijoiam9leWNyZWF0b3IiLCJhIjoiY21pNTA0ZW5tMmNobDJrb2xnZHMzdGZ0biJ9.Ohr-h7iBEDpvKTJUl2S9AQ";

      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/standard",
        center: [-75.0, 42.0],
        zoom: 4,
        attributionControl: false,
      });

      // D√©placer l'attribution
      map.addControl(
        new mapboxgl.AttributionControl({
          compact: true,
          customAttribution: "Donn√©es: SPC NOAA / NEXRAD / IGO Qu√©bec (MSP)",
        }),
        "top-right"
      );

      // ----------------------------------------------------------------
      // Chargement des donn√©es
      // ----------------------------------------------------------------
      map.on("load", () => {
        // ================================================================
        // === COUCHES IGO (QU√âBEC) ===
        // ================================================================

        // --- IGO 1. FOND DE CARTE TOPOGRAPHIQUE PUBLIC (TMS) - CORRIG√â ---
        map.addSource("igo-base-map", {
          type: "raster",
          tiles: [
            "https://geoegl.msp.gouv.qc.ca/carto/tms/1.0.0/carte_gouv_qc_public@EPSG_3857/{z}/{x}/{y}.png",
          ],
          // Correction pour l'erreur 404: Mapbox g√®re l'inversion de l'axe Y pour le service TMS
          scheme: "tms",
          tileSize: 256,
          minzoom: 0,
          maxzoom: 18,
          attribution: "Fond de carte IGO: Gouvernement du Qu√©bec",
        });

        map.addLayer({
          id: "igo-base-layer",
          type: "raster",
          source: "igo-base-map",
          beforeId: "waterway-label",
          paint: {
            "raster-opacity": 0.8,
          },
        });

        // --- NOUVELLE COUCHE 2. IGO √âV√âNEMENTS HISTORIQUES (GeoJSON WFS) ---
        const historiqueEventsUrl =
          "https://geoegl.msp.gouv.qc.ca/apis/wss/historiquesc.fcgi?service=wfs&version=1.1.0&request=getfeature&typename=msp_risc_evenements_public&outputformat=geojson&srsName=epsg:4326";

        map.addSource("historique-events-source", {
          type: "geojson",
          data: historiqueEventsUrl,
          attribution: "√âv√©nements Historiques: MSP (IGO)",
        });

        // Visualisation des √©v√©nements historiques (points)
        map.addLayer({
          id: "historique-events-circle",
          type: "circle",
          source: "historique-events-source",
          paint: {
            "circle-color": "#800080", // Violet pour les donn√©es historiques
            "circle-radius": 6,
            "circle-stroke-width": 1.5,
            "circle-stroke-color": "#ffffff",
            "circle-opacity": 0.8,
          },
          // Plac√© sous le radar et les alertes m√©t√©o
          beforeId: "nexrad-image",
        });

        // Ajout de l'interactivit√© pour les √©v√©nements historiques
        map.on("click", "historique-events-circle", (e) => {
          const properties = e.features[0].properties;
          let description = "<strong>√âv√©nement Historique MSP</strong><br>";

          // Construit le contenu du popup
          for (const key in properties) {
            if (
              properties.hasOwnProperty(key) &&
              properties[key] !== null &&
              key !== "geom"
            ) {
              // Limiter l'affichage des valeurs trop longues
              const value =
                typeof properties[key] === "string" &&
                properties[key].length > 100
                  ? properties[key].substring(0, 100) + "..."
                  : properties[key];

              description += `<strong>${key}</strong>: ${value}<br>`;
            }
          }

          new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(description)
            .addTo(map);
        });

        map.on("mouseenter", "historique-events-circle", () => {
          map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "historique-events-circle", () => {
          map.getCanvas().style.cursor = "";
        });

        // ================================================================
        // === COUCHES M√âT√âO (USA) - CODE EXISTANT ===
        // ================================================================

        // --- 3. COUCHE RADAR NEXRAD (Raster) ---

        const radarTileUrl =
          "https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png";

        map.addSource("nexrad-radar", {
          type: "raster",
          tiles: [radarTileUrl],
          tileSize: 256,
          minzoom: 0,
          maxzoom: 12,
          attribution:
            'Radar: NEXRAD via <a href="https://mesonet.agron.iastate.edu/" target="_blank">Iowa State Mesonet</a>',
        });

        map.addLayer({
          id: "nexrad-image",
          type: "raster",
          source: "nexrad-radar",
          paint: {
            "raster-opacity": 0.8,
          },
        });

        // --- 4. COUCHE SPC NOAA (GeoJSON) ---

        map.addSource("spc-outlook", {
          type: "geojson",
          data: "https://www.spc.noaa.gov/products/outlook/day1otlk_cat.lyr.geojson",
        });

        const spcColors = [
          "match",
          ["get", "DN"],
          1,
          "#FFFF00",
          2,
          "#FFA500",
          3,
          "#FF4500",
          4,
          "#FF0000",
          "#CCCCCC",
        ];

        map.addLayer({
          id: "spc-polygons",
          type: "fill",
          source: "spc-outlook",
          beforeId: "waterway-label",
          paint: {
            "fill-color": spcColors,
            "fill-opacity": 0.6,
            "fill-outline-color": "#000000",
          },
        });

        map.addLayer({
          id: "spc-lines",
          type: "line",
          source: "spc-outlook",
          layout: {},
          paint: {
            "line-color": "#000000",
            "line-width": 2,
          },
        });

        // --- 5. Interactivit√© : Popup et Curseur (GeoJSON SPC) ---

        map.on("click", "spc-polygons", (e) => {
          const properties = e.features[0].properties;
          const description = Object.keys(properties)
            .map((key) => `<strong>${key}</strong>: ${properties[key]}`)
            .join("<br>");

          new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(description)
            .addTo(map);
        });

        map.on("mouseenter", "spc-polygons", () => {
          map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "spc-polygons", () => {
          map.getCanvas().style.cursor = "";
        });

        // --- 6. Fonction d'Animation (Player) ---

        document
          .getElementById("play-button")
          .addEventListener("click", toggleAnimation);

        let animationInterval = null;
        let isPlaying = false;
        const animationSteps = [0.2, 0.4, 0.6, 0.8];
        let currentStepIndex = 0;

        function toggleAnimation() {
          const button = document.getElementById("play-button");
          const display = document.getElementById("time-display");

          if (isPlaying) {
            clearInterval(animationInterval);
            isPlaying = false;
            button.innerHTML = "‚ñ∂Ô∏è D√©marrer l'Animation";
            display.textContent = "Heure : Statique";
            if (map.getLayer("spc-polygons")) {
              map.setPaintProperty("spc-polygons", "fill-opacity", 0.6);
            }
          } else {
            isPlaying = true;
            button.innerHTML = "‚è∏Ô∏è Arr√™ter l'Animation";

            animationInterval = setInterval(() => {
              currentStepIndex = (currentStepIndex + 1) % animationSteps.length;
              const opacity = animationSteps[currentStepIndex];
              const timeLabel = `√âtape ${currentStepIndex + 1} / 4`;

              if (map.getLayer("spc-polygons")) {
                map.setPaintProperty("spc-polygons", "fill-opacity", opacity);
              }

              display.textContent = `Heure : ${timeLabel} (Opacit√©: ${opacity.toFixed(
                1
              )})`;
            }, 500);
          }
        }
      });
    </script>
  </body>
</html>
