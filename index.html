<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Weather and Geomatics Alerts - SPC / NEXRAD / IGO</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* CSS Base */
      body {
        margin: 0;
        padding: 0;
        font-family: "Roboto", sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        /* DARK MODE: Very dark background */
        background-color: #1e1e1e;
        color: #cccccc; /* Default text color */
      }

      /* --- Header Style --- */
      header {
        /* DARK MODE: Neutral dark header */
        background-color: #333333;
        color: white;
        padding: 18px 30px;
        font-size: 1.6em;
        font-weight: 700;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        z-index: 10;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* Header links container */
      .header-links a {
        color: white;
        text-decoration: none;
        margin-left: 20px;
        font-size: 0.85em;
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        transition: background-color 0.2s;
        font-weight: 400;
      }

      .header-links a:hover {
        /* DARK MODE: Slightly lighter hover */
        background-color: #555555;
      }

      /* Main container */
      #main-container {
        display: flex;
        flex: 1;
        position: relative;
      }

      /* --- Sidebar Style --- */
      #sidebar {
        width: 320px;
        /* DARK MODE: Slightly lighter than body */
        background-color: #2d2d2d;
        padding: 25px;
        overflow-y: auto;
        box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
        z-index: 5;
        border-right: none;
      }

      /* Legend and titles style */
      #sidebar h3,
      #sidebar h4 {
        margin-top: 0;
        /* DARK MODE: Light text for titles */
        color: #ffffff;
        /* DARK MODE: Darker border line */
        border-bottom: 1px solid #444444;
        padding-bottom: 8px;
        margin-bottom: 20px;
        font-weight: 700;
      }

      /* General list styles */
      #sidebar ul {
        padding-left: 20px;
        margin: 10px 0 20px 0;
        font-size: 0.95em;
      }

      /* Player and Toggle Button Style */
      #play-button,
      #toggle-base-map {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.05em;
        font-weight: 700;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s, transform 0.1s;
        width: 100%;
        margin-bottom: 10px; /* Space between buttons */
      }

      #play-button:disabled,
      #toggle-base-map:disabled {
        background-color: #555555;
        cursor: not-allowed;
      }

      #play-button:hover:not(:disabled),
      #toggle-base-map:hover:not(:disabled) {
        background-color: #388e3c;
      }

      #play-button:active:not(:disabled),
      #toggle-base-map:active:not(:disabled) {
        transform: scale(0.98);
      }

      /* Light Mode Button Styling */
      .light-mode-active {
        background-color: #1e88e5 !important; /* Blue for light mode */
      }
      .light-mode-active:hover:not(:disabled) {
        background-color: #1565c0 !important;
      }

      /* --- Map Style --- */
      #map {
        flex: 1;
        position: relative;
      }
      /* Fix for Leaflet popups on dark background */
      .leaflet-popup-content-wrapper,
      .leaflet-popup-tip {
        background: #333333;
        color: #cccccc;
      }

      /* Legend styles for SPC alerts */
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        font-size: 0.95em;
      }
      .legend-color {
        width: 25px;
        height: 25px;
        margin-right: 15px;
        /* Ensure border is visible on dark background */
        border: 2px solid #000;
        opacity: 0.7;
        border-radius: 4px;
      }

      /* Horizontal separator style */
      hr {
        border: 0;
        /* DARK MODE: Darker separator line */
        border-top: 1px solid #444444;
        margin: 20px 0;
      }

      /* --- Footer Style --- */
      footer {
        /* DARK MODE: Matches header/neutral dark */
        background-color: #333333;
        color: #ffffff;
        padding: 12px 30px;
        text-align: center;
        font-size: 0.8em;
        /* Ensures footer is below main content */
        flex-shrink: 0;
        border-top: 1px solid #444444;
      }

      /* --- Loading Spinner Styles (NEW) --- */
      #loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        /* Must cover the map area */
        z-index: 100;
        /* Dark background for contrast */
        background-color: rgba(30, 30, 30, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.2em;
        font-weight: 400;
        /* Initially set to show */
        transition: opacity 0.3s;
      }

      /* The actual spinner CSS (using border trick) */
      .spinner {
        border: 8px solid #444444; /* Light grey border */
        border-top: 8px solid #4caf50; /* Green/Accent color for spin */
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* --- Media Query for Mobile/Small Screens (max 768px) --- */
      @media (max-width: 768px) {
        /* 1. Main Container (vertical stacking) */
        #main-container {
          flex-direction: column;
        }

        /* 2. Header Style */
        header {
          padding: 15px 20px;
          font-size: 1.4em;
          display: block;
          text-align: center;
        }
        .header-links {
          display: none;
        }

        /* 3. Sidebar (full width) */
        #sidebar {
          width: auto; /* Takes full available width */
          padding: 20px; /* Adjust padding */
          height: auto; /* Height defined by content */
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
          border-bottom: 1px solid #444444;
          order: -1;
        }

        /* 4. Map (takes remaining vertical space and must have a fixed height) */
        #map {
          height: 60vh; /* IMPORTANT for mobile view */
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>Weather and Geomatics Alerts - SPC / NEXRAD / IGO</div>

      <div class="header-links">
        <a href="https://github.com/drjoeycadieux" target="_blank">
          <span role="img" aria-label="GitHub">üêô</span> GitHub
        </a>
        <a href="https://x.com/drjoeycadieux" target="_blank">
          <span role="img" aria-label="X">üê¶‚Äç‚¨õ</span> X
        </a>
      </div>
    </header>

    <div id="main-container">
      <aside id="sidebar">
        <h3>SPC Alerts Legend</h3>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #ffff00"></div>
          <span>1 - Marginal Risk</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #ffa500"></div>
          <span>2 - Slight Risk</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #ff4500"></div>
          <span>3 - Enhanced / Moderate Risk</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #ff0000"></div>
          <span>4 - High Risk</span>
        </div>

        <hr />

        <h4>Active Layers</h4>
        <ul id="active-layers-list">
          <li id="base-map-status">**CartoDB Dark Base Map**</li>
          <li>**IGO Historical Events** (GeoJSON)</li>
          <li>NEXRAD Radar (Tile Layer)</li>
          <li id="spc-layer-status">SPC NOAA Forecasts (GeoJSON)</li>
        </ul>

        <hr />

        <h4>Data Controls</h4>
        <button id="toggle-base-map">üí° Switch to Light Map</button>
        <button id="play-button" disabled>‚ñ∂Ô∏è Start Animation</button>
        <div
          id="time-display"
          style="
            margin-top: 15px;
            font-weight: 700;
            /* DARK MODE: Light text for time display */
            color: #cccccc;
            text-align: center;
          "
        >
          Time: Static
        </div>
      </aside>

      <div id="map">
        <div id="loading-overlay">
          <div class="spinner"></div>
          Loading Map and Weather Data...
        </div>
      </div>
    </div>

    <footer>
      **Map and Data Sources** | &copy; 2025 | Sources : SPC NOAA, NEXRAD, IGO
      Qu√©bec (MSP). For educational and non-commercial use.
    </footer>

    <script>
      // ----------------------------------------------------------------
      // Global Variables and Map Initialization
      // ----------------------------------------------------------------

      // Map Instance
      const map = L.map("map", {
        center: [39.8, -98.5],
        zoom: 4,
        minZoom: 2,
        attributionControl: false,
      });

      // Layer References (Declared globally for access by functions)
      let spcLayer = null;
      let animationInterval = null;
      let isPlaying = false;
      let currentBaseLayer = null; // To hold the active base map layer
      let isDarkMode = true; // State for the map theme

      let currentStepIndex = 0;
      const animationSteps = [0.2, 0.4, 0.6, 0.8]; // Opacity steps for animation

      // DOM Elements
      const loadingOverlay = document.getElementById("loading-overlay");
      const playButton = document.getElementById("play-button");
      const timeDisplay = document.getElementById("time-display");
      const spcStatus = document.getElementById("spc-layer-status");
      const baseMapStatus = document.getElementById("base-map-status");
      const toggleButton = document.getElementById("toggle-base-map");

      // Tile Layer Definitions
      const baseMaps = {
        dark: L.tileLayer(
          "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
          {
            attribution: "&copy; CARTO Dark | Sources: OSM, NEXRAD, IGO",
            maxZoom: 19,
            subdomains: "abcd",
          }
        ),
        light: L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            attribution: "&copy; OpenStreetMap | Sources: OSM, NEXRAD, IGO",
            maxZoom: 19,
            subdomains: "abcd",
          }
        ),
      };

      // Color mapping function
      const spcColors = (dn) => {
        switch (dn) {
          case 1:
            return "#FFFF00"; // Marginal
          case 2:
            return "#FFA500"; // Slight
          case 3:
            return "#FF4500"; // Enhanced / Moderate
          case 4:
            return "#FF0000"; // High
          default:
            return "#CCCCCC";
        }
      };

      // ----------------------------------------------------------------
      // Leaflet Setup & Base Layer Toggle
      // ----------------------------------------------------------------

      function setupMap() {
        // Attribution Control
        L.control
          .attribution({
            position: "bottomright",
            prefix:
              " &copy; 2025 | Sources : SPC NOAA, NEXRAD, IGO Qu√©bec (MSP). For educational and non-commercial use.",
          })
          .addTo(map);

        // Add the initial Dark Base Map Layer
        currentBaseLayer = baseMaps.dark;
        currentBaseLayer.addTo(map);
        baseMapStatus.textContent = "**CartoDB Dark Base Map**";

        // Fix for Leaflet rendering in Flexbox container
        map.whenReady(function () {
          this.invalidateSize();
        });
      }

      function toggleBaseMap() {
        // 1. Remove the current layer
        if (currentBaseLayer) {
          map.removeLayer(currentBaseLayer);
        }

        // 2. Switch mode and set the new layer
        if (isDarkMode) {
          // Switch to Light Mode
          currentBaseLayer = baseMaps.light;
          toggleButton.innerHTML = "üåô Switch to Dark Map";
          baseMapStatus.textContent = "**OSM Standard Base Map**";
          toggleButton.classList.add("light-mode-active");
          isDarkMode = false;
        } else {
          // Switch to Dark Mode
          currentBaseLayer = baseMaps.dark;
          toggleButton.innerHTML = "üí° Switch to Light Map";
          baseMapStatus.textContent = "**CartoDB Dark Base Map**";
          toggleButton.classList.remove("light-mode-active");
          isDarkMode = true;
        }

        // 3. Add the new layer to the map
        currentBaseLayer.addTo(map).bringToBack();
      }

      // ----------------------------------------------------------------
      // Layer Loading Functions
      // ----------------------------------------------------------------

      function loadIgoLayers() {
        // IGO Public Topographic Base Map (This one acts as an overlay/secondary map, not the main base)
        const igoBaseLayer = L.tileLayer(
          "https://geoegl.msp.gouv.qc.ca/carto/tms/1.0.0/carte_gouv_qc_public@EPSG_3857/{z}/{x}/{y}.png",
          {
            attribution: "IGO Base Map: Government of Quebec",
            tms: true,
            opacity: 0.8,
            maxZoom: 18,
          }
        ).addTo(map);

        // IGO Historical Events (GeoJSON)
        const historiqueEventsUrl =
          "https://geoegl.msp.gouv.qc.ca/apis/wss/historiquesc.fcgi?service=wfs&version=1.1.0&request=getfeature&typename=msp_risc_evenements_public&outputformat=geojson&srsName=epsg:4326";

        fetch(historiqueEventsUrl)
          .then((response) => {
            if (!response.ok)
              throw new Error("IGO Fetch failed: " + response.statusText);
            return response.json();
          })
          .then((data) => {
            L.geoJSON(data, {
              pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                  radius: 6,
                  fillColor: "#800080", // Purple
                  color: "#ffffff", // White stroke
                  weight: 1.5,
                  opacity: 0.8,
                  fillOpacity: 0.8,
                });
              },
              onEachFeature: function (feature, layer) {
                let description = "<strong>MSP Historical Event</strong><br>";
                for (const key in feature.properties) {
                  if (feature.properties.hasOwnProperty(key)) {
                    const value =
                      typeof feature.properties[key] === "string" &&
                      feature.properties[key].length > 100
                        ? feature.properties[key].substring(0, 100) + "..."
                        : feature.properties[key];
                    if (value !== null && key !== "geom") {
                      description += `<strong>${key}</strong>: ${value}<br>`;
                    }
                  }
                }
                layer.bindPopup(description);
              },
            }).addTo(map);
          })
          .catch((error) =>
            console.error("Error loading IGO historical events:", error)
          );
      }

      function loadWeatherLayers() {
        // NEXRAD Radar Layer
        const radarTileUrl =
          "https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png";

        L.tileLayer(radarTileUrl, {
          attribution:
            'Radar: NEXRAD via <a href="https://mesonet.agron.iastate.edu/" target="_blank">Iowa State Mesonet</a>',
          opacity: 0.8,
          maxZoom: 12,
        }).addTo(map);

        // SPC NOAA Layer (GeoJSON)
        fetch(
          "https://www.spc.noaa.gov/products/outlook/day1otlk_cat.lyr.geojson"
        )
          .then((response) => {
            if (!response.ok)
              throw new Error("SPC Fetch failed: " + response.statusText);
            return response.json();
          })
          .then((data) => {
            spcLayer = L.geoJSON(data, {
              style: function (feature) {
                return {
                  fillColor: spcColors(feature.properties.DN),
                  weight: 2,
                  opacity: 1,
                  color: "black",
                  fillOpacity: 0.6, // Default opacity
                };
              },
              onEachFeature: function (feature, layer) {
                const properties = feature.properties;
                const description = Object.keys(properties)
                  .map((key) => `<strong>${key}</strong>: ${properties[key]}`)
                  .join("<br>");

                layer.bindPopup(description);

                layer.on("mouseover", function () {
                  map.getContainer().style.cursor = "pointer";
                });
                layer.on("mouseout", function () {
                  map.getContainer().style.cursor = "";
                });
              },
            }).addTo(map);

            // ENABLE animation only if SPC data loads successfully
            playButton.disabled = false;
            spcStatus.textContent = "SPC NOAA Forecasts (GeoJSON) - Loaded";
          })
          .catch((error) => {
            console.error(
              "Error loading SPC data (animation disabled):",
              error
            );
            // Update status text on failure
            spcStatus.textContent =
              "SPC NOAA Forecasts (GeoJSON) - FAILED to load";
          });
      }

      // ----------------------------------------------------------------
      // Animation Logic
      // ----------------------------------------------------------------

      function toggleAnimation() {
        if (!spcLayer) {
          console.warn("SPC Layer not loaded. Cannot start animation.");
          return;
        }

        if (isPlaying) {
          clearInterval(animationInterval);
          isPlaying = false;
          playButton.innerHTML = "‚ñ∂Ô∏è Start Animation";
          timeDisplay.textContent = "Time: Static";
          // Reset opacity to default when stopped
          spcLayer.setStyle({ fillOpacity: 0.6 });
        } else {
          isPlaying = true;
          playButton.innerHTML = "‚è∏Ô∏è Stop Animation";

          animationInterval = setInterval(() => {
            currentStepIndex = (currentStepIndex + 1) % animationSteps.length;
            const opacity = animationSteps[currentStepIndex];
            const timeLabel = `Step ${currentStepIndex + 1} / ${
              animationSteps.length
            }`;

            // Update GeoJSON layer opacity
            spcLayer.setStyle({ fillOpacity: opacity });

            timeDisplay.textContent = `Time: ${timeLabel} (Opacity: ${opacity.toFixed(
              1
            )})`;
          }, 500);
        }
      }

      // ----------------------------------------------------------------
      // Main Execution & Event Listeners
      // ----------------------------------------------------------------

      document.addEventListener("DOMContentLoaded", () => {
        setupMap();
        loadIgoLayers();
        loadWeatherLayers();

        // Event listeners for the buttons
        playButton.addEventListener("click", toggleAnimation);
        toggleButton.addEventListener("click", toggleBaseMap); // New listener for base map toggle

        // Hide loading spinner after a short delay
        setTimeout(() => {
          loadingOverlay.style.opacity = "0";
          setTimeout(() => {
            loadingOverlay.style.display = "none";
          }, 300);
        }, 500);
      });
    </script>
  </body>
</html>
