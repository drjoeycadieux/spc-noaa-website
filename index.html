<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Weather and Geomatics Alerts - SPC / NEXRAD / IGO / MSC</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <meta
      name="description"
      content="Interactive weather alerts map with SPC NOAA, NEXRAD radar, IGO Qu√©bec, and MSC CAP alerts"
    />

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* CSS Reset and Base Styles */
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: "Roboto", sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: #1e1e1e;
        color: #e0e0e0;
        line-height: 1.5;
      }

      /* --- Header Style --- */
      header {
        background: linear-gradient(135deg, #2c3e50 0%, #1a2530 100%);
        color: white;
        padding: 16px 30px;
        font-size: 1.5em;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #34495e;
      }

      .header-title {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header-title::before {
        content: "üå™Ô∏è";
        font-size: 1.2em;
      }

      /* Header links container */
      .header-links {
        display: flex;
        gap: 10px;
      }

      .header-links a {
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-weight: 500;
        font-size: 0.85em;
        display: flex;
        align-items: center;
        gap: 5px;
        background-color: rgba(255, 255, 255, 0.1);
      }

      .header-links a:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      /* Main container */
      #main-container {
        display: flex;
        flex: 1;
        position: relative;
        overflow: hidden;
      }

      /* --- Sidebar Style --- */
      #sidebar {
        width: 340px;
        background: linear-gradient(to bottom, #2d2d2d, #252525);
        padding: 25px;
        overflow-y: auto;
        box-shadow: 4px 0 15px rgba(0, 0, 0, 0.3);
        z-index: 100;
        border-right: 1px solid #444;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* Sidebar sections */
      .sidebar-section {
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 18px;
        border: 1px solid #444;
      }

      /* Legend and titles style */
      .sidebar-section h3 {
        margin: 0 0 15px 0;
        color: #ffffff;
        font-weight: 700;
        font-size: 1.2em;
        padding-bottom: 8px;
        border-bottom: 1px solid #444;
      }

      .sidebar-section h4 {
        margin: 0 0 12px 0;
        color: #ffffff;
        font-weight: 600;
        font-size: 1.1em;
      }

      /* General list styles */
      #sidebar ul {
        padding-left: 20px;
        margin: 10px 0;
        font-size: 0.95em;
      }

      #sidebar li {
        margin-bottom: 8px;
        position: relative;
      }

      #sidebar li::before {
        content: "‚ñ∏";
        position: absolute;
        left: -15px;
        color: #4caf50;
      }

      /* Player Button Style */
      #play-button {
        background: linear-gradient(to bottom, #4caf50, #388e3c);
        color: white;
        border: none;
        padding: 14px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.05em;
        font-weight: 700;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        width: 100%;
        margin-bottom: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
      }

      #play-button:disabled {
        background: #555555;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      #play-button:hover:not(:disabled) {
        background: linear-gradient(to bottom, #388e3c, #2e7d32);
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
      }

      #play-button:active:not(:disabled) {
        transform: translateY(0);
      }

      /* --- Map Style --- */
      #map {
        flex: 1;
        position: relative;
      }

      /* Fix for Leaflet popups on dark background */
      .leaflet-popup-content-wrapper,
      .leaflet-popup-tip {
        background: #333333;
        color: #e0e0e0;
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4);
      }

      .leaflet-popup-content {
        font-family: "Roboto", sans-serif;
        font-size: 0.95em;
        line-height: 1.5;
      }

      /* Legend styles for SPC alerts */
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        font-size: 0.95em;
      }

      .legend-color {
        width: 28px;
        height: 28px;
        margin-right: 15px;
        border: 2px solid rgba(255, 255, 255, 0.7);
        opacity: 0.9;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .legend-label {
        display: flex;
        flex-direction: column;
      }

      .risk-level {
        font-weight: 700;
      }

      .risk-code {
        font-size: 0.85em;
        opacity: 0.8;
      }

      /* Horizontal separator style */
      hr {
        border: 0;
        border-top: 1px solid #444;
        margin: 20px 0;
      }

      /* --- Footer Style --- */
      footer {
        background: linear-gradient(135deg, #2c3e50 0%, #1a2530 100%);
        color: #e0e0e0;
        padding: 14px 30px;
        text-align: center;
        font-size: 0.85em;
        flex-shrink: 0;
        border-top: 1px solid #34495e;
      }

      /* --- Loading Spinner Styles --- */
      #loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        background: linear-gradient(135deg, #1a2530 0%, #2c3e50 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.2em;
        font-weight: 500;
        transition: opacity 0.5s ease;
      }

      /* The actual spinner CSS */
      .spinner {
        border: 8px solid rgba(255, 255, 255, 0.2);
        border-top: 8px solid #4caf50;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1.2s linear infinite;
        margin-bottom: 25px;
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        text-align: center;
        max-width: 300px;
      }

      /* Status indicators */
      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-active {
        background-color: #4caf50;
        box-shadow: 0 0 8px #4caf50;
      }

      .status-inactive {
        background-color: #f44336;
      }

      .status-loading {
        background-color: #ffc107;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.5;
        }
      }

      /* Time display */
      #time-display {
        margin-top: 15px;
        font-weight: 700;
        color: #e0e0e0;
        text-align: center;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        border: 1px solid #444;
      }

      /* Layer controls */
      .layer-control {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .layer-control input {
        margin-right: 10px;
      }

      .layer-control label {
        display: flex;
        align-items: center;
        flex: 1;
        cursor: pointer;
      }

      /* --- Media Query for Mobile/Small Screens (max 768px) --- */
      @media (max-width: 768px) {
        #main-container {
          flex-direction: column;
        }

        header {
          padding: 14px 20px;
          font-size: 1.3em;
          flex-direction: column;
          gap: 10px;
          text-align: center;
        }

        .header-links {
          width: 100%;
          justify-content: center;
        }

        #sidebar {
          width: 100%;
          padding: 20px;
          height: auto;
          max-height: 40vh;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
          border-bottom: 1px solid #444;
          order: -1;
        }

        #map {
          height: 60vh;
        }

        .sidebar-section {
          padding: 15px;
        }
      }

      /* Additional small screen adjustments */
      @media (max-width: 480px) {
        header {
          font-size: 1.1em;
          padding: 12px 15px;
        }

        .header-links a {
          padding: 6px 12px;
          font-size: 0.8em;
        }

        #sidebar {
          padding: 15px;
        }

        .sidebar-section {
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-title">Weather and Geomatics Alerts</div>
      <div class="header-links">
        <a
          href="https://github.com/drjoeycadieux/spc-noaa-website"
          target="_blank"
          rel="noopener"
        >
          <span role="img" aria-label="GitHub">üêô</span> GitHub
        </a>
        <a href="https://x.com/drjoeycadieux" target="_blank" rel="noopener">
          <span role="img" aria-label="X">üê¶‚Äç‚¨õ</span> X
        </a>
      </div>
    </header>

    <div id="main-container">
      <aside id="sidebar">
        <div class="sidebar-section">
          <h3>SPC Convective Outlook</h3>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #005500"></div>
            <div class="legend-label">
              <span class="risk-level">Marginal Risk</span>
              <span class="risk-code">(MRGL)</span>
            </div>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #ddaa00"></div>
            <div class="legend-label">
              <span class="risk-level">Slight Risk</span>
              <span class="risk-code">(SLGT)</span>
            </div>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #ff6600"></div>
            <div class="legend-label">
              <span class="risk-level">Enhanced Risk</span>
              <span class="risk-code">(ENH)</span>
            </div>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #cc0000"></div>
            <div class="legend-label">
              <span class="risk-level">Moderate Risk</span>
              <span class="risk-code">(MDT)</span>
            </div>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #cc00cc"></div>
            <div class="legend-label">
              <span class="risk-level">High Risk</span>
              <span class="risk-code">(HIGH)</span>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <h4>Active Layers</h4>
          <ul id="active-layers-list">
            <li>
              <span class="status-indicator status-active"></span>IGO Historical
              Events (GeoJSON)
            </li>
            <li>
              <span class="status-indicator status-active"></span>NEXRAD Radar
              (Tile Layer)
            </li>
            <li id="spc-layer-status">
              <span class="status-indicator status-loading"></span>SPC NOAA
              Forecasts (GeoJSON)
            </li>
            <li>
              <span class="status-indicator status-active"></span>Hydro-Quebec
              <a
                style="color: #4caf50; text-decoration: none; font-weight: 500"
                href="/pages/index-hq.html"
                target="_blank"
                rel="noopener noreferrer"
                >Outages Map</a
              >
            </li>
          </ul>
        </div>

        <div class="sidebar-section">
          <h4>Data Controls</h4>
          <button id="play-button" disabled>
            <span id="play-icon">‚ñ∂Ô∏è</span>
            <span id="play-text">Start Animation</span>
          </button>
          <div id="time-display">Time: Static</div>
        </div>

        <div class="sidebar-section">
          <h4>Layer Controls</h4>
          <div class="layer-control">
            <input type="checkbox" id="spc-toggle" checked />
            <label for="spc-toggle">SPC Outlook</label>
          </div>
          <div class="layer-control">
            <input type="checkbox" id="radar-toggle" checked />
            <label for="radar-toggle">NEXRAD Radar</label>
          </div>
          <div class="layer-control">
            <input type="checkbox" id="igo-toggle" checked />
            <label for="igo-toggle">IGO Events</label>
          </div>
        </div>
      </aside>

      <div id="map">
        <div id="loading-overlay">
          <div class="spinner"></div>
          <div class="loading-text">Loading Map and Weather Data...</div>
        </div>
      </div>
    </div>

    <footer>
      <strong>Map and Data Sources</strong> | &copy; 2025 | Sources: SPC NOAA,
      NEXRAD, IGO Qu√©bec (MSP), MSC CAP. For educational and non-commercial use.
    </footer>

    <script>
      // ----------------------------------------------------------------
      // Global Variables and Map Initialization
      // ----------------------------------------------------------------

      // Map Instance
      const map = L.map("map", {
        center: [39.8, -98.6],
        zoom: 4,
        minZoom: 2,
        attributionControl: false,
      });

      // Layer References
      let spcLayer = null;
      let capLayer = null;
      let igoLayer = null;
      let radarLayer = null;
      let animationInterval = null;
      let isPlaying = false;
      let currentBaseLayer = null;

      let currentStepIndex = 0;
      const animationSteps = [0.2, 0.4, 0.6, 0.8];

      // DOM Elements
      const loadingOverlay = document.getElementById("loading-overlay");
      const playButton = document.getElementById("play-button");
      const playIcon = document.getElementById("play-icon");
      const playText = document.getElementById("play-text");
      const timeDisplay = document.getElementById("time-display");
      const spcStatus = document.getElementById("spc-layer-status");
      const activeLayersList = document.getElementById("active-layers-list");

      // Layer toggle controls
      const spcToggle = document.getElementById("spc-toggle");
      const radarToggle = document.getElementById("radar-toggle");
      const igoToggle = document.getElementById("igo-toggle");

      // Tile Layer Definitions
      const baseMaps = {
        light: L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            attribution:
              "&copy; OpenStreetMap | Sources: OSM, NEXRAD, IGO, MSC",
            maxZoom: 19,
            subdomains: "abcd",
          }
        ),
      };

      // CORRECTED color mapping function for SPC
      const spcColors = (dn) => {
        switch (dn) {
          case 1:
            return "#005500"; // Marginal - Dark Green
          case 2:
            return "#DDAA00"; // Slight - Gold/Yellow
          case 3:
            return "#FF6600"; // Enhanced - Orange
          case 4:
            return "#CC0000"; // Moderate - Red
          case 5:
            return "#CC00CC"; // High - Magenta
          default:
            return "#CCCCCC"; // Default for any unexpected values
        }
      };

      // CAP Alert Color Mapping based on Severity
      const capColors = (severity) => {
        if (!severity) return "gray";
        switch (severity.toLowerCase()) {
          case "severe":
            return "#FF00FF";
          case "extreme":
            return "#990099";
          case "moderate":
            return "#FF8C00";
          case "minor":
            return "#00BFFF";
          default:
            return "#6495ED";
        }
      };

      // ----------------------------------------------------------------
      // Leaflet Setup
      // ----------------------------------------------------------------

      function setupMap() {
        L.control
          .attribution({
            position: "bottomright",
            prefix:
              " &copy; 2025 | Sources: SPC NOAA, NEXRAD, IGO Qu√©bec (MSP), MSC CAP Alert. For educational and non-commercial use.",
          })
          .addTo(map);

        // Initialize with the Light Map
        currentBaseLayer = baseMaps.light;
        currentBaseLayer.addTo(map);

        map.whenReady(function () {
          this.invalidateSize();
        });
      }

      // ----------------------------------------------------------------
      // CAP Alert XML to GeoJSON Conversion Logic
      // ----------------------------------------------------------------

      /**
       * Parses a CAP-XML string and converts the primary polygon area into a GeoJSON Feature.
       */
      function capXmlToGeoJSON(capXmlString) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(capXmlString, "application/xml");

        if (xmlDoc.querySelector("parsererror")) {
          console.error(
            "Error parsing CAP XML:",
            xmlDoc.querySelector("parsererror").textContent
          );
          return null;
        }

        const infoNode = xmlDoc.querySelector("info");
        if (!infoNode) {
          console.warn("CAP XML is missing the <info> block.");
          return null;
        }

        // Extract core properties
        const properties = {
          headline:
            infoNode.querySelector("headline")?.textContent ||
            "Alert Headline Missing",
          description:
            infoNode.querySelector("description")?.textContent ||
            "No description provided.",
          severity:
            infoNode.querySelector("severity")?.textContent || "Unknown",
          event:
            infoNode.querySelector("event")?.textContent || "General Alert",
          expires: infoNode.querySelector("expires")?.textContent,
        };

        // Extract Geometry
        const areaNode = infoNode.querySelector("area");
        const polygonNode = areaNode?.querySelector("polygon");

        if (!polygonNode) {
          console.warn("CAP XML is missing the <polygon> geometry.");
          return null;
        }

        const rawCoords = polygonNode.textContent.trim();
        const pairs = rawCoords.split(/\s+/);

        const coordinates = pairs.map((pair) => {
          const [lat, lon] = pair.split(",").map(Number);
          // CRITICAL: Convert from CAP's Lat,Lon to GeoJSON's Lon,Lat
          return [lon, lat];
        });

        // Build GeoJSON Feature
        return {
          type: "Feature",
          properties: properties,
          geometry: {
            type: "Polygon",
            coordinates: [coordinates],
          },
        };
      }

      /**
       * Loads the CAP alert data onto the Leaflet map.
       */
      function loadCapAlert(capXmlString) {
        const capGeoJson = capXmlToGeoJSON(capXmlString);

        if (!capGeoJson) {
          // Appending a new list item for the CAP status since it's an optional layer
          const newCapStatusLi = document.createElement("li");
          newCapStatusLi.innerHTML = `<span class="status-indicator status-inactive"></span>MSC CAP Alert: FAILED to load or parse sample.`;
          activeLayersList.appendChild(newCapStatusLi);
          return;
        }

        // Remove existing layer if it exists
        if (capLayer) {
          map.removeLayer(capLayer);
        }

        // Add the resulting GeoJSON to the map
        capLayer = L.geoJSON(capGeoJson, {
          style: function (feature) {
            const color = capColors(feature.properties.severity);
            return {
              fillColor: color,
              weight: 3,
              opacity: 1,
              color: "#FFFFFF", // White border
              dashArray: "5, 5", // Dashed border for alerts
              fillOpacity: 0.6,
            };
          },
          onEachFeature: function (feature, layer) {
            const properties = feature.properties;
            const popupContent = `
              <h4 style="margin: 0; color: ${capColors(
                properties.severity
              )};">${properties.event}</h4>
              <strong>Headline:</strong> ${properties.headline}<br>
              <strong>Severity:</strong> ${properties.severity}<br>
              <strong>Expires:</strong> ${
                properties.expires
                  ? new Date(properties.expires).toLocaleString()
                  : "N/A"
              }<br>
              <hr style="border-color: #555;">
              <p style="margin: 5px 0 0 0;">${properties.description.substring(
                0,
                300
              )}...</p>
            `;
            layer.bindPopup(popupContent);
            layer.on("click", () => {
              map.fitBounds(layer.getBounds(), { padding: [50, 50] });
            });
          },
        }).addTo(map);

        // Update Layer Status
        const newCapStatusLi = document.createElement("li");
        newCapStatusLi.innerHTML = `<span class="status-indicator status-active"></span>MSC CAP Alert: ${capGeoJson.properties.headline} (${capGeoJson.properties.severity})`;
        activeLayersList.appendChild(newCapStatusLi);

        console.log("CAP Alert successfully loaded and added to map.");
      }

      // ----------------------------------------------------------------
      // Layer Loading Functions (IGO, NEXRAD, SPC)
      // ----------------------------------------------------------------

      function loadIgoLayers() {
        // IGO Public Topographic Base Map
        const igoBaseLayer = L.tileLayer(
          "https://geoegl.msp.gouv.qc.ca/carto/tms/1.0.0/carte_gouv_qc_public@EPSG_3857/{z}/{x}/{y}.png",
          {
            attribution: "IGO Base Map: Government of Quebec",
            tms: true,
            opacity: 0.8,
            maxZoom: 18,
          }
        ).addTo(map);

        // IGO Historical Events (GeoJSON)
        const historiqueEventsUrl =
          "https://geoegl.msp.gouv.qc.ca/apis/wss/historiquesc.fcgi?service=wfs&version=1.1.0&request=getfeature&typename=msp_risc_evenements_public&outputformat=geojson&srsName=epsg:4326";

        fetch(historiqueEventsUrl)
          .then((response) => {
            if (!response.ok)
              throw new Error("IGO Fetch failed: " + response.statusText);
            return response.json();
          })
          .then((data) => {
            igoLayer = L.geoJSON(data, {
              pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                  radius: 6,
                  fillColor: "#800080",
                  color: "#ffffff",
                  weight: 1.5,
                  opacity: 0.8,
                  fillOpacity: 0.8,
                });
              },
              onEachFeature: function (feature, layer) {
                let description = "<strong>MSP Historical Event</strong><br>";
                for (const key in feature.properties) {
                  if (feature.properties.hasOwnProperty(key)) {
                    const value =
                      typeof feature.properties[key] === "string" &&
                      feature.properties[key].length > 100
                        ? feature.properties[key].substring(0, 100) + "..."
                        : feature.properties[key];
                    if (value !== null && key !== "geom") {
                      description += `<strong>${key}</strong>: ${value}<br>`;
                    }
                  }
                }
                layer.bindPopup(description);
              },
            }).addTo(map);

            // Set up toggle functionality
            igoToggle.addEventListener("change", function () {
              if (igoToggle.checked) {
                map.addLayer(igoLayer);
              } else {
                map.removeLayer(igoLayer);
              }
            });
          })
          .catch((error) => {
            console.error("Error loading IGO historical events:", error);
            document.querySelector("#igo-toggle").disabled = true;
          });
      }

      function loadWeatherLayers() {
        // NEXRAD Radar Layer
        const radarTileUrl =
          "https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png";

        radarLayer = L.tileLayer(radarTileUrl, {
          attribution:
            'Radar: NEXRAD via <a href="https://mesonet.agron.iastate.edu/" target="_blank">Iowa State Mesonet</a>',
          opacity: 0.8,
          maxZoom: 12,
        }).addTo(map);

        // Set up toggle functionality
        radarToggle.addEventListener("change", function () {
          if (radarToggle.checked) {
            map.addLayer(radarLayer);
          } else {
            map.removeLayer(radarLayer);
          }
        });

        // SPC NOAA Layer (GeoJSON)
        fetch(
          "https://www.spc.noaa.gov/products/outlook/day1otlk_cat.lyr.geojson"
        )
          .then((response) => {
            if (!response.ok)
              throw new Error("SPC Fetch failed: " + response.statusText);
            return response.json();
          })
          .then((data) => {
            spcLayer = L.geoJSON(data, {
              style: function (feature) {
                return {
                  fillColor: spcColors(feature.properties.DN),
                  weight: 2,
                  opacity: 1,
                  color: "black",
                  fillOpacity: 0.6,
                };
              },
              onEachFeature: function (feature, layer) {
                const properties = feature.properties;
                const description = Object.keys(properties)
                  .map((key) => `<strong>${key}</strong>: ${properties[key]}`)
                  .join("<br>");

                layer.bindPopup(description);

                layer.on("mouseover", function () {
                  map.getContainer().style.cursor = "pointer";
                });
                layer.on("mouseout", function () {
                  map.getContainer().style.cursor = "";
                });
              },
            }).addTo(map);

            // Set up toggle functionality
            spcToggle.addEventListener("change", function () {
              if (spcToggle.checked) {
                map.addLayer(spcLayer);
              } else {
                map.removeLayer(spcLayer);
              }
            });

            // ENABLE animation only if SPC data loads successfully
            playButton.disabled = false;
            spcStatus.innerHTML =
              '<span class="status-indicator status-active"></span>SPC NOAA Forecasts (GeoJSON) - Loaded';
          })
          .catch((error) => {
            console.error(
              "Error loading SPC data (animation disabled):",
              error
            );
            spcStatus.innerHTML =
              '<span class="status-indicator status-inactive"></span>SPC NOAA Forecasts (GeoJSON) - FAILED to load';
            spcToggle.disabled = true;
          });
      }

      // ----------------------------------------------------------------
      // Animation Logic
      // ----------------------------------------------------------------

      function toggleAnimation() {
        if (!spcLayer) {
          console.warn("SPC Layer not loaded. Cannot start animation.");
          return;
        }

        if (isPlaying) {
          clearInterval(animationInterval);
          isPlaying = false;
          playIcon.textContent = "‚ñ∂Ô∏è";
          playText.textContent = "Start Animation";
          timeDisplay.textContent = "Time: Static";
          spcLayer.setStyle({ fillOpacity: 0.6 });
        } else {
          isPlaying = true;
          playIcon.textContent = "‚è∏Ô∏è";
          playText.textContent = "Stop Animation";

          animationInterval = setInterval(() => {
            currentStepIndex = (currentStepIndex + 1) % animationSteps.length;
            const opacity = animationSteps[currentStepIndex];
            const timeLabel = `Step ${currentStepIndex + 1} / ${
              animationSteps.length
            }`;

            spcLayer.setStyle({ fillOpacity: opacity });

            timeDisplay.textContent = `Time: ${timeLabel} (Opacity: ${opacity.toFixed(
              1
            )})`;
          }, 500);
        }
      }

      // ----------------------------------------------------------------
      // Main Execution & Event Listeners
      // ----------------------------------------------------------------

      document.addEventListener("DOMContentLoaded", () => {
        setupMap();
        loadIgoLayers();
        loadWeatherLayers();

        // --- MSC CAP ALERT DATA LOADING ---
        const capAlertUrl = "T_WWCN11_C_CWVR_202511190220_1187808547.cap";

        // Placeholder CAP-XML string (used if fetch fails)
        const sampleCapXml = `
          <?xml version="1.0" encoding="UTF-8"?>
          <alert xmlns="urn:oasis:names:tc:emergency:cap:1.2">
          <identifier>MSC-Alert-SAMPLE-4321</identifier>
          <sender>CWTO</sender>
          <sent>2025-11-19T06:00:00-05:00</sent>
          <status>Actual</status>
          <msgType>Alert</msgType>
          <scope>Public</scope>
          <info>
              <language>en-CA</language>
              <category>Met</category>
              <event>Severe Thunderstorm Warning</event>
              <responseType>Shelter</responseType>
              <urgency>Immediate</urgency>
              <severity>Severe</severity>
              <certainty>Observed</certainty>
              <effective>2025-11-19T06:00:00-05:00</effective>
              <expires>2025-11-19T08:00:00-05:00</expires>
              <headline>SAMPLE: Severe Thunderstorm Warning for Southern Quebec</headline>
              <description>Conditions are favourable for the development of dangerous thunderstorms that may be capable of producing large hail, damaging winds, and heavy rain. Take shelter immediately (This is sample data).</description>
              <area>
              <areaDesc>Montreal - Laval - Longueuil Region (SAMPLE)</areaDesc>
              <polygon>45.5017,-73.5673 45.4583,-73.9400 45.6983,-73.7433 45.8167,-73.2733 45.5017,-73.5673</polygon>
              </area>
          </info>
          </alert>
        `;

        // Attempt to fetch the file
        fetch(capAlertUrl)
          .then((response) => {
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);
            return response.text();
          })
          .then((xmlString) => {
            loadCapAlert(xmlString);
          })
          .catch((error) => {
            console.warn(
              `Could not fetch CAP file from ${capAlertUrl}. Falling back to sample data. Error:`,
              error
            );
            loadCapAlert(sampleCapXml);
          });
        // ----------------------------------------------------------------

        // Event listeners
        playButton.addEventListener("click", toggleAnimation);

        // Hide loading spinner
        setTimeout(() => {
          loadingOverlay.style.opacity = "0";
          setTimeout(() => {
            loadingOverlay.style.display = "none";
          }, 500);
        }, 1000);
      });
    </script>
  </body>
</html>
